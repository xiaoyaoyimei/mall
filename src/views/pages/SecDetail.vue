<template>
	<div>
	<div class="m_header_bar">
			<router-link to="/seckill"  class="m_header_bar_back"><Icon type="ios-arrow-back"></Icon></router-link>
			<span class="m_header_bar_title">秒杀详情</span>
		</div>
	<div class="detail">
		<div class="tp">
		<img :src="detail.productItem.listImg | imgfilter"/>
		<p class="jg">
		<span>￥{{detail.crush.salePrice | pricefilter}}</span>
		<span class="yj">￥{{detail.productItem.salePrice | pricefilter}}</span>	
		</p>
		</div>
		      <div class="chooseAddress">
            	<ul class="address" v-if="youdizhi">
				<li>
					<p><strong>{{addressList.person}} <label>{{addressList.phone}}</label></strong>
					<span>{{addressList.receiveProvince}}{{addressList.receiveCity}}{{addressList.receiveDistrict}}{{addressList.address}}</span></p>
						<Icon type="chevron-right"  @click.native="addAdd"></Icon>
				</li>
			   </ul>
                <div  class="zeroAddress" v-else >
                	<div @click="addAdd">
                		请选择收货地址
                	<Icon class='float float1' type="ios-arrow-right"></Icon>
                  </div>
                </div>
            </div>
		<div class="xq">
		<p>{{detail.product.modelName}}</p>	
		 <div>数量 <InputNumber  :min="1"  v-model="quantity" :max="detail.crush.unitQuantity*1"></InputNumber></div>
		 </div>
	</div>
	       <Tabs class="spjs">
        <TabPane label="商品介绍">
        	<ul><li v-for="(item, index) in productimg"  :key="index"><img :src="item.imgUrl |imgfilter"></li></ul>
        </TabPane>
        <TabPane label="规格参数" >
        		<ul class="gk">
        			<li v-for="(item, index) in productDesc"  :key="index">
        			<span class="title">{{item.attrCode}}:</span> <span class="neirong">{{item.attrValue}}</span></li></ul>
        </TabPane>
    </Tabs>
	    <div class="foot"> 
	    	<button :loading="loading" @click="confirm" class="miaoshagou">马上抢</button>
  		  </div>  
	</div>
</template>
<script>
		export default {
	    data () {
	        return {
	        	detail:{
	        		productItem:{},
	        		product:{},
	        		crush:{}
	        	},
	        	skuId:'',
	        	quantity:1,
	        	loading:true,
	        	youdizhi:false,
	        	proId:'',
	        	productDesc:[],
	        	productimg:[],
	        	temp:'',
	        	addressList:{},
	        }
	      },
	      methods:{
	      	//获取address中传来的数据
	      	getDD(){
                let routerParams = this.$route.params.address;
                if(routerParams!=undefined){
                	this.addressList=routerParams;
                	this.youdizhi=true
                }
        	},
	       addAdd(){
	       	     localStorage.setItem('fromc','miaosha')
        		 this.$router.push({name: '/user/address'}) ;
        	},
		    getAddress(){
		      	var _this=this;
		      	  	this.$axios({
						    method: 'post',
						    url:'/address',
						}).then((res)=>{
							 if(res.length>0){
							 	res.map(function (i) {
							 		if(i.isDefault=='Y'&&JSON.stringify(_this.addressList) == "{}"){
							 			_this.addressList=i;
							 			 _this.youdizhi=true
							 		}
							 	});
								
							}
						});
		      },
		      confirm(){
	          	let para={
						addressId:this.addressList.id,
						quantity:this.quantity,
	                    skuId:this.temp
	          	};
    	   	  	this.$axios({
				    method: 'post',
				    url:'/promotion/crush/confirm',
				    data:para
				}).then((res)=>{
					if(res.code=='200'){
						 this.$router.push({name:'/cartthree',query: { orderNo: res.msg}});  
					}else{
						 this.$Message.error(res.object);
						 return;
					}
				});
           },
	      	getDetail(){
	      		if(this.$route.query.skuId!=null&&this.$route.query.skuId!=undefined){
	      			  sessionStorage.setItem('temp',this.$route.query.skuId);
	      		}
	      		   if(sessionStorage.getItem('temp')!="undefined"&&sessionStorage.getItem('temp')!=null){
	      		   	this.temp=sessionStorage.getItem('temp');
	      		   }
	      		   else{
	      		   	 sessionStorage.setItem('temp',this.$route.query.skuId);
	      		   	 this.temp  =this.$route.query.skuId;
	      		   }
	      			this.$axios({
					    method: 'get',
					    url:'/promotion/crush/'+  this.temp,
					}).then((res)=>{
						if(res.code=='200'){
						this.detail = res.object;
						this.proId=res.object.productItem.productId;
								this.$axios({
							    method: 'post',
							    url:'/product/desc/'+this.proId,
								}).then((res)=>{
								this.productDesc=res;
							});
								this.$axios({
							    method: 'post',
							    url:'/product/img/'+this.proId,
								}).then((res)=>{
										this.productimg=res;
							});
						}
					});
					
					}
			 },
	      mounted(){
	      	this.getAddress();
			  this.getDetail()
			  this.getDD();
	      }
    }
</script>

<style scoped="scoped" lang="scss">
	.detail {
		.tp{
		 position:relative;
		img{
			display: block;
			width:100%;
			text-align: center;
		}
		}
	}
	.jg {
		color: #fff;
		background: #d71777;
		position: absolute;
		bottom:0;
		left: 0;
		padding: 5px;
		span{
		color:#fff;
		display: block;
		}
		.yj{
			text-decoration:line-through;
			font-size: 1.2rem;
		}
	}
	.xq{
		padding: 1rem;
		margin-bottom: 1rem;
		margin-top: 1rem;
		background: #fff;
		p{
			margin-bottom: 1rem;
		}
	}
	.chooseAddress{
		margin-top: 10px;;
	}

</style>
<style>
	.spjs .ivu-tabs-nav{
		width:100%
	}
	.spjs .ivu-tabs-tab{
		font-size: 1.6rem;
		width:50%;
		text-align: center;
	}
	</style>